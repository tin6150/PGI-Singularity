Bootstrap: docker
From: centos:7

%post
    yum groupinstall -y "Development tools"
    yum install -y wget which  csh tcsh zsh  vim  bc tree 
    # meld (in epel)  - https://centos.pkgs.org/7/epel-x86_64/meld-3.16.4-2.el7.noarch.rpm.html
    # no fish shell yet in centos7?
  
    curl -H 'Referer: https://www.pgroup.com/products/community.htm' -LO 'https://www.pgroup.com/support/downloader.php?file=pgi-community-linux-x64'

    tar xpfz downloader.php?file=pgi-community-linux-x64
    
    export PGI_SILENT=true
    export PGI_ACCEPT_EULA=accept
    export PG_INSTALL_DIR=/opt/pgi
    export PGI_INSTALL_TYPE=single
    export PGI_INSTALL_JAVA=true
    export PGI_INSTALL_MPI=true
    export PGI_MPI_GPU_SUPPORT=true
    ./install

    
    yum install -y libcurl-devel zlib-devel

    wget https://support.hdfgroup.org/ftp/HDF5/releases/hdf5-1.8/hdf5-1.8.21/src/hdf5-1.8.21.tar.gz
    tar xzf hdf5-1.8.21.tar.gz
    cd hdf5-1.8.21
    export CC=/opt/pgi/linux86-64/19.4/bin/pgcc
    ./configure --prefix=/usr/local
    make install

    #NetCDF, both C and fortran
    wget https://github.com/Unidata/netcdf-c/archive/v4.7.0.tar.gz
    tar -zxf v4.7.0.tar.gz
    cd netcdf-c-4.7.0
    ./configure --enable-remote-fortran-bootstrap
    make
    make install
    cd .. 

		# container constructed from .def may not need this
    # but i need it now for interactive compile of cmaq
		echo "tin:x:43143:100:tin:/home/tin:/bin/bash" >> /etc/passwd
	  pwconv
		chown 43143 /opt
    
%environment
    export PGI=/opt/pgi
    export PATH=/opt/pgi/linux86-64/19.4/bin:$PATH
    export MANPATH=$MANPATH:/opt/pgi/linux86-64/19.4/man
    export LM_LICENSE_FILE=$LM_LICENSE_FILE:/opt/pgi/license.dat

%runscript
    pgcc $@

%help
    Container containing PGI compilers
    
    Usage:

        singularity exec <singularity image> <command> <args>

    PGI commands include pgf77, pgfortran, pgcc, pgc++, pgdbg, and pgprof.
    When using a PGI compiler, it is recommended to use statically link the PGI librarires using the -Bstatic_pgi command flag.

    Example:

        singularity exec <singularity image> pgcc -Bstatic_pgi <source.c>

